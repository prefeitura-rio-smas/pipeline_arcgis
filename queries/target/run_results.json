{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.4", "generated_at": "2025-06-17T14:23:46.598955Z", "invocation_id": "76ccdb4c-b98e-40fc-912f-8d39b61248c8", "env": {}}, "results": [{"status": "error", "timing": [{"name": "compile", "started_at": "2025-06-17T14:23:45.827082Z", "completed_at": "2025-06-17T14:23:45.839490Z"}, {"name": "execute", "started_at": "2025-06-17T14:23:45.840049Z", "completed_at": "2025-06-17T14:23:46.541103Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.7184159755706787, "adapter_response": {}, "message": "Database Error in model stg_repeat_names_cluster (models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql)\n  Syntax error: Unexpected \";\" at [89:36]\n  compiled code at target/run/queries/models/dashboard_arcgis/staging/stg_repeat_names_cluster.sql", "failures": null, "unique_id": "model.queries.stg_repeat_names_cluster", "compiled": true, "compiled_code": "\n\nWITH base AS (\n  SELECT\n    parentrowid,\n    nome_usuario_norm AS nm,\n    nome_mae_norm     AS mm\n  FROM `rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names`\n),\n\n-- 1) BLOQUEIO \u2500 s\u00f3 pelo SOUNDEX do nome da pessoa\nblocked AS (\n  SELECT *,\n         SOUNDEX(nm) AS block_key\n  FROM base\n),\n\n-- 2) GERAR pares dentro do bloco\npairs AS (\n  SELECT\n    a.parentrowid AS id_a,\n    b.parentrowid AS id_b,\n\n    EDIT_DISTANCE(a.nm, b.nm) AS d_nm,\n    EDIT_DISTANCE(a.mm, b.mm) AS d_mm,\n\n    SPLIT(a.nm, ' ') AS a_nm_tok,\n    SPLIT(b.nm, ' ') AS b_nm_tok,\n    SPLIT(a.mm, ' ') AS a_mm_tok,\n    SPLIT(b.mm, ' ') AS b_mm_tok\n  FROM blocked a\n  JOIN blocked b\n    ON a.block_key = b.block_key\n   AND a.parentrowid < b.parentrowid          -- evita reflexivos\n),\n\n-- 3) M\u00c9TRICA de conten\u00e7\u00e3o   inter / menor \u2265 0.80\nscored AS (\n  SELECT *,\n    ARRAY_LENGTH(ARRAY(\n        SELECT x FROM UNNEST(a_nm_tok) x\n        INTERSECT DISTINCT\n        SELECT y FROM UNNEST(b_nm_tok) y\n    )) / LEAST(ARRAY_LENGTH(a_nm_tok), ARRAY_LENGTH(b_nm_tok))  AS cont_nm,\n\n    ARRAY_LENGTH(ARRAY(\n        SELECT x FROM UNNEST(a_mm_tok) x\n        INTERSECT DISTINCT\n        SELECT y FROM UNNEST(b_mm_tok) y\n    )) / LEAST(ARRAY_LENGTH(a_mm_tok), ARRAY_LENGTH(b_mm_tok))  AS cont_mm\n  FROM pairs\n),\n\n-- 4) DUPLICADOS: (dist \u22642 OR cont \u22650.8) em AMBAS as colunas\ndupes AS (\n  SELECT id_a, id_b\n  FROM scored\n  WHERE (d_nm <= 2 OR cont_nm >= 0.8)\n    AND (d_mm <= 2 OR cont_mm >= 0.8)\n),\n\n-- 5) CLUSTER: componente conexa via menor parentrowid\ngraph AS (\n  SELECT parentrowid, parentrowid       AS neighbour FROM base   -- singlet\n  UNION ALL\n  SELECT id_a, id_b FROM dupes\n  UNION ALL\n  SELECT id_b, id_a FROM dupes          -- torna o grafo n\u00e3o-direcionado\n),\n\nclustered AS (\n  SELECT\n    parentrowid,\n    MIN(neighbour) OVER (PARTITION BY parentrowid) AS cluster_seed\n  FROM graph\n)\n\nSELECT DISTINCT\n  b.parentrowid,\n  MIN(cluster_seed) OVER (PARTITION BY cluster_seed) AS cluster_id,\n  COUNT(*)        OVER (PARTITION BY cluster_seed)   AS cluster_size,\n  cluster_size > 1                                   AS is_duplicado\nFROM base b\nJOIN clustered USING (parentrowid);", "relation_name": "`rj-smas-dev`.`dashboard_arcgis_dev`.`stg_repeat_names_cluster`", "batch_results": null}], "elapsed_time": 2.327486276626587, "args": {"print": true, "profiles_dir": "queries", "introspect": true, "require_resource_names_without_spaces": false, "target": "dev", "warn_error_options": {"include": [], "exclude": []}, "indirect_selection": "eager", "log_file_max_bytes": 10485760, "log_level": "info", "macro_debugging": false, "require_yaml_configuration_for_mf_time_spines": false, "quiet": false, "select": ["stg_repeat_names_cluster"], "log_path": "queries/logs", "use_colors_file": true, "version_check": true, "require_nested_cumulative_type_params": false, "show_resource_report": false, "log_format": "default", "static_parser": true, "printer_width": 80, "require_explicit_package_overrides_for_builtin_materializations": true, "state_modified_compare_vars": false, "source_freshness_run_project_hooks": false, "send_anonymous_usage_stats": true, "require_batched_execution_for_custom_microbatch_strategy": false, "log_format_file": "debug", "log_level_file": "debug", "partial_parse": true, "favor_state": false, "skip_nodes_if_on_run_start_fails": false, "project_dir": "queries", "use_colors": true, "populate_cache": true, "cache_selected_only": false, "empty": false, "defer": false, "which": "run", "exclude": [], "partial_parse_file_diff": true, "strict_mode": false, "vars": {}, "write_json": true, "invocation_command": "dbt run --project-dir queries --profiles-dir queries --select stg_repeat_names_cluster", "state_modified_compare_more_unrendered_values": false}}